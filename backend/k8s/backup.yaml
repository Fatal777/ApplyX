# ============================================================
# PostgreSQL Backup CronJob - Automated daily backups to S3
# ============================================================
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgresql-backup
  namespace: applyx
  labels:
    app: pg-backup
spec:
  # Run daily at 2 AM UTC
  schedule: "0 2 * * *"
  # Keep 3 successful and 1 failed job history
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  # Don't allow concurrent backup jobs
  concurrencyPolicy: Forbid
  # Start job within 5 minutes of scheduled time
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      # Retry failed backups up to 2 times
      backoffLimit: 2
      # Timeout after 1 hour
      activeDeadlineSeconds: 3600
      template:
        metadata:
          labels:
            app: pg-backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: pg-backup
              image: postgres:15-alpine
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  
                  # Generate timestamp for backup file
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="applyx_backup_${TIMESTAMP}.sql.gz"
                  
                  echo "Starting PostgreSQL backup: ${BACKUP_FILE}"
                  
                  # Create backup with compression
                  PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
                    -h "${POSTGRES_HOST}" \
                    -p "${POSTGRES_PORT}" \
                    -U "${POSTGRES_USER}" \
                    -d "${POSTGRES_DB}" \
                    --no-owner \
                    --no-acl \
                    --clean \
                    --if-exists \
                    | gzip > "/tmp/${BACKUP_FILE}"
                  
                  BACKUP_SIZE=$(du -h "/tmp/${BACKUP_FILE}" | cut -f1)
                  echo "Backup created: ${BACKUP_FILE} (${BACKUP_SIZE})"
                  
                  # Upload to S3
                  if [ -n "${AWS_S3_BUCKET}" ]; then
                    echo "Uploading to S3: s3://${AWS_S3_BUCKET}/backups/postgresql/"
                    
                    # Install AWS CLI if not present
                    if ! command -v aws &> /dev/null; then
                      apk add --no-cache aws-cli
                    fi
                    
                    aws s3 cp "/tmp/${BACKUP_FILE}" \
                      "s3://${AWS_S3_BUCKET}/backups/postgresql/${BACKUP_FILE}" \
                      --storage-class STANDARD_IA
                    
                    echo "Backup uploaded successfully"
                    
                    # Clean up old backups (keep last 30 days)
                    echo "Cleaning up backups older than 30 days..."
                    aws s3 ls "s3://${AWS_S3_BUCKET}/backups/postgresql/" | \
                      while read -r line; do
                        createDate=$(echo $line | awk '{print $1" "$2}')
                        createDate=$(date -d "$createDate" +%s)
                        olderThan=$(date -d "30 days ago" +%s)
                        if [[ $createDate -lt $olderThan ]]; then
                          fileName=$(echo $line | awk '{print $4}')
                          if [[ $fileName != "" ]]; then
                            aws s3 rm "s3://${AWS_S3_BUCKET}/backups/postgresql/$fileName"
                            echo "Deleted old backup: $fileName"
                          fi
                        fi
                      done
                  else
                    echo "WARNING: AWS_S3_BUCKET not set, backup stored locally only"
                    # Copy to persistent volume
                    cp "/tmp/${BACKUP_FILE}" "/backups/${BACKUP_FILE}"
                  fi
                  
                  # Cleanup temp file
                  rm -f "/tmp/${BACKUP_FILE}"
                  
                  echo "Backup completed successfully"
              env:
                - name: POSTGRES_HOST
                  value: "postgresql.applyx.svc.cluster.local"
                - name: POSTGRES_PORT
                  value: "5432"
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: applyx-secrets
                      key: POSTGRES_USER
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: applyx-secrets
                      key: POSTGRES_PASSWORD
                - name: POSTGRES_DB
                  value: "applyx"
                - name: AWS_S3_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: applyx-secrets
                      key: S3_BUCKET_NAME
                      optional: true
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: applyx-secrets
                      key: AWS_ACCESS_KEY_ID
                      optional: true
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: applyx-secrets
                      key: AWS_SECRET_ACCESS_KEY
                      optional: true
                - name: AWS_DEFAULT_REGION
                  value: "us-east-1"
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
              volumeMounts:
                - name: backup-volume
                  mountPath: /backups
          volumes:
            - name: backup-volume
              persistentVolumeClaim:
                claimName: applyx-backups-pvc
---
# ============================================================
# PostgreSQL Backup PVC
# ============================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: applyx-backups-pvc
  namespace: applyx
  labels:
    app: pg-backup
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
---
# ============================================================
# Manual backup job (trigger with: kubectl create job --from=cronjob/postgresql-backup manual-backup-<date>)
# ============================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-backup-manual
  namespace: applyx
  labels:
    app: pg-backup
    type: manual
spec:
  # Don't auto-start, use for manual triggers
  suspend: true
  template:
    metadata:
      labels:
        app: pg-backup
    spec:
      restartPolicy: Never
      containers:
        - name: pg-backup
          image: postgres:15-alpine
          command:
            - /bin/sh
            - -c
            - |
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="applyx_manual_backup_${TIMESTAMP}.sql.gz"
              echo "Creating manual backup: ${BACKUP_FILE}"
              PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
                -h postgresql.applyx.svc.cluster.local \
                -U "${POSTGRES_USER}" \
                -d applyx \
                | gzip > "/backups/${BACKUP_FILE}"
              echo "Manual backup completed: ${BACKUP_FILE}"
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: applyx-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: applyx-secrets
                  key: POSTGRES_PASSWORD
          volumeMounts:
            - name: backup-volume
              mountPath: /backups
      volumes:
        - name: backup-volume
          persistentVolumeClaim:
            claimName: applyx-backups-pvc
---
# ============================================================
# Restore Job Template
# ============================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-restore
  namespace: applyx
  labels:
    app: pg-restore
spec:
  # Suspend by default - set BACKUP_FILE env and unsuspend to run
  suspend: true
  template:
    metadata:
      labels:
        app: pg-restore
    spec:
      restartPolicy: Never
      containers:
        - name: pg-restore
          image: postgres:15-alpine
          command:
            - /bin/sh
            - -c
            - |
              set -e
              
              if [ -z "${BACKUP_FILE}" ]; then
                echo "ERROR: BACKUP_FILE environment variable not set"
                exit 1
              fi
              
              # Check if restoring from S3 or local
              if [[ "${BACKUP_FILE}" == s3://* ]]; then
                echo "Downloading backup from S3..."
                apk add --no-cache aws-cli
                aws s3 cp "${BACKUP_FILE}" /tmp/restore.sql.gz
                RESTORE_FILE="/tmp/restore.sql.gz"
              else
                RESTORE_FILE="/backups/${BACKUP_FILE}"
              fi
              
              if [ ! -f "${RESTORE_FILE}" ]; then
                echo "ERROR: Backup file not found: ${RESTORE_FILE}"
                exit 1
              fi
              
              echo "Restoring database from: ${RESTORE_FILE}"
              
              gunzip -c "${RESTORE_FILE}" | PGPASSWORD="${POSTGRES_PASSWORD}" psql \
                -h postgresql.applyx.svc.cluster.local \
                -U "${POSTGRES_USER}" \
                -d applyx
              
              echo "Database restore completed successfully"
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: applyx-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: applyx-secrets
                  key: POSTGRES_PASSWORD
            - name: BACKUP_FILE
              value: ""  # Set this before running
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: applyx-secrets
                  key: AWS_ACCESS_KEY_ID
                  optional: true
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: applyx-secrets
                  key: AWS_SECRET_ACCESS_KEY
                  optional: true
          volumeMounts:
            - name: backup-volume
              mountPath: /backups
      volumes:
        - name: backup-volume
          persistentVolumeClaim:
            claimName: applyx-backups-pvc
