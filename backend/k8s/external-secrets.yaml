# ============================================================
# External Secrets Operator - Secret rotation from Vault/AWS
# ============================================================
# Prerequisites:
# 1. Install External Secrets Operator: 
#    helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
# 2. Configure SecretStore for your provider (AWS, Vault, GCP, etc.)

---
# ============================================================
# SecretStore - AWS Secrets Manager
# ============================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: applyx
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        # Option 1: Use IAM role (recommended for EKS with IRSA)
        jwt:
          serviceAccountRef:
            name: applyx-secrets-sa
        # Option 2: Use access keys (stored in a secret)
        # secretRef:
        #   accessKeyIDSecretRef:
        #     name: aws-credentials
        #     key: access-key-id
        #   secretAccessKeySecretRef:
        #     name: aws-credentials
        #     key: secret-access-key
---
# ============================================================
# SecretStore - HashiCorp Vault
# ============================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-secret-store
  namespace: applyx
spec:
  provider:
    vault:
      server: "https://vault.applyx.io:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "applyx-role"
          serviceAccountRef:
            name: applyx-secrets-sa
---
# ============================================================
# ExternalSecret - Pull secrets from AWS Secrets Manager
# ============================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: applyx-external-secrets
  namespace: applyx
spec:
  # Refresh secrets every hour
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: applyx-secrets
    creationPolicy: Owner
    # Merge with existing secret if present
    deletionPolicy: Retain
  data:
    # Database credentials
    - secretKey: DATABASE_URL
      remoteRef:
        key: applyx/production/database
        property: url
    
    - secretKey: POSTGRES_USER
      remoteRef:
        key: applyx/production/database
        property: username
    
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: applyx/production/database
        property: password
    
    # JWT secrets
    - secretKey: SECRET_KEY
      remoteRef:
        key: applyx/production/jwt
        property: secret_key
    
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: applyx/production/jwt
        property: jwt_secret
    
    - secretKey: ENCRYPTION_KEY
      remoteRef:
        key: applyx/production/jwt
        property: encryption_key
    
    # OpenAI API key
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: applyx/production/openai
        property: api_key
    
    # ElevenLabs API key
    - secretKey: ELEVENLABS_API_KEY
      remoteRef:
        key: applyx/production/elevenlabs
        property: api_key
    
    # Supabase credentials
    - secretKey: SUPABASE_URL
      remoteRef:
        key: applyx/production/supabase
        property: url
    
    - secretKey: SUPABASE_KEY
      remoteRef:
        key: applyx/production/supabase
        property: anon_key
    
    - secretKey: SUPABASE_JWT_SECRET
      remoteRef:
        key: applyx/production/supabase
        property: jwt_secret
    
    # AWS credentials
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: applyx/production/aws
        property: access_key_id
    
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: applyx/production/aws
        property: secret_access_key
    
    - secretKey: S3_BUCKET_NAME
      remoteRef:
        key: applyx/production/aws
        property: s3_bucket
    
    # Sentry DSN
    - secretKey: SENTRY_DSN
      remoteRef:
        key: applyx/production/sentry
        property: dsn
    
    # Redis URL (if using external Redis)
    - secretKey: REDIS_URL
      remoteRef:
        key: applyx/production/redis
        property: url
        decodingStrategy: None
---
# ============================================================
# ExternalSecret - Pull from Vault
# ============================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: applyx-vault-secrets
  namespace: applyx
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: vault-secret-store
    kind: SecretStore
  target:
    name: applyx-secrets
    creationPolicy: Merge
  dataFrom:
    - extract:
        key: secret/data/applyx/production
---
# ============================================================
# ServiceAccount for External Secrets
# ============================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: applyx-secrets-sa
  namespace: applyx
  annotations:
    # For AWS EKS with IRSA
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/applyx-secrets-role
---
# ============================================================
# ClusterSecretStore - Cluster-wide secret store (optional)
# ============================================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: global-aws-secrets
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets
---
# ============================================================
# PushSecret - Sync K8s secrets TO external store (optional)
# Useful for rotating secrets that are generated in-cluster
# ============================================================
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: applyx-push-secrets
  namespace: applyx
spec:
  # Sync every 10 minutes
  refreshInterval: 10m
  secretStoreRefs:
    - name: aws-secrets-manager
      kind: SecretStore
  selector:
    secret:
      name: applyx-generated-secrets
  data:
    - match:
        secretKey: rotation-token
        remoteRef:
          remoteKey: applyx/production/rotation-token
