apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: applyx
  labels:
    app: grafana
    grafana_dashboard: "1"
data:
  applyx-dashboard.json: |
    {
      "annotations": { "list": [] },
      "description": "ApplyX Application Dashboard",
      "editable": true,
      "panels": [
        {
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
          "id": 1,
          "title": "Request Rate",
          "type": "stat",
          "targets": [{ "expr": "sum(rate(applyx_http_requests_total[5m]))" }]
        },
        {
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
          "id": 2,
          "title": "Avg Latency (p50)",
          "type": "stat",
          "targets": [{ "expr": "histogram_quantile(0.50, sum(rate(applyx_http_request_duration_seconds_bucket[5m])) by (le))" }]
        },
        {
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
          "id": 3,
          "title": "Error Rate %",
          "type": "stat",
          "targets": [{ "expr": "sum(rate(applyx_http_requests_total{status_code=~\"5..\"}[5m])) / sum(rate(applyx_http_requests_total[5m])) * 100" }]
        },
        {
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
          "id": 4,
          "title": "Active Sessions",
          "type": "stat",
          "targets": [{ "expr": "sum(applyx_interview_sessions_total{status=\"in_progress\"})" }]
        }
      ],
      "refresh": "30s",
      "title": "ApplyX Overview",
      "uid": "applyx-overview"
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: applyx
  labels:
    app: grafana
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-service.applyx.svc.cluster.local:9090
        isDefault: true
        editable: false
      - name: Jaeger
        type: jaeger
        access: proxy
        url: http://jaeger-query.applyx.svc.cluster.local:16686
        editable: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: applyx
  labels:
    app: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'applyx-cluster'
        environment: 'production'
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets: []
    
    rule_files: []
    
    scrape_configs:
      # ApplyX API metrics
      - job_name: 'applyx-api'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - applyx
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: applyx-api
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "8000"
            action: keep
        metrics_path: /metrics
        scrape_interval: 10s
      
      # Celery worker metrics
      - job_name: 'applyx-celery'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - applyx
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: applyx-celery-worker
            action: keep
        metrics_path: /metrics
        scrape_interval: 30s
      
      # Redis metrics (if using redis-exporter)
      - job_name: 'redis'
        static_configs:
          - targets: ['redis-exporter:9121']
        scrape_interval: 30s
      
      # PostgreSQL metrics (if using postgres-exporter)
      - job_name: 'postgresql'
        static_configs:
          - targets: ['postgres-exporter:9187']
        scrape_interval: 30s
      
      # Kubernetes node metrics
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: applyx
  labels:
    app: otel-collector
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      prometheus:
        config:
          scrape_configs:
            - job_name: 'otel-collector'
              scrape_interval: 10s
              static_configs:
                - targets: ['localhost:8888']
    
    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      memory_limiter:
        check_interval: 1s
        limit_mib: 1000
        spike_limit_mib: 200
      resource:
        attributes:
          - key: service.namespace
            value: applyx
            action: upsert
    
    exporters:
      # Export to Jaeger for distributed tracing
      jaeger:
        endpoint: jaeger-collector.applyx.svc.cluster.local:14250
        tls:
          insecure: true
      
      # Export metrics to Prometheus
      prometheus:
        endpoint: "0.0.0.0:8889"
        namespace: applyx
      
      # Logging for debugging
      logging:
        loglevel: info
    
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      zpages:
        endpoint: 0.0.0.0:55679
    
    service:
      extensions: [health_check, zpages]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch, resource]
          exporters: [jaeger, logging]
        metrics:
          receivers: [otlp, prometheus]
          processors: [memory_limiter, batch]
          exporters: [prometheus, logging]
