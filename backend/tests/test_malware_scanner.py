"""Tests for malware scanner"""

import pytest
import tempfile
import os
from app.services.malware_scanner import MalwareScanner


def test_calculate_file_hash():
    """Test file hash calculation"""
    with tempfile.NamedTemporaryFile(mode='w', delete=False) as f:
        f.write("Test content")
        temp_path = f.name
    
    try:
        hash_value = MalwareScanner.calculate_file_hash(temp_path)
        assert len(hash_value) == 64  # SHA256 hash length
    finally:
        os.unlink(temp_path)


def test_scan_safe_file():
    """Test scanning a safe file"""
    with tempfile.NamedTemporaryFile(mode='w', delete=False) as f:
        f.write("This is a safe document content")
        temp_path = f.name
    
    try:
        is_safe, reason = MalwareScanner.scan_file_content(temp_path)
        assert is_safe is True
        assert reason is None
    finally:
        os.unlink(temp_path)


def test_scan_suspicious_file():
    """Test scanning a file with suspicious content"""
    with tempfile.NamedTemporaryFile(mode='wb', delete=False) as f:
        f.write(b"Normal content <script>alert('xss')</script>")
        temp_path = f.name
    
    try:
        is_safe, reason = MalwareScanner.scan_file_content(temp_path)
        assert is_safe is False
        assert reason is not None
    finally:
        os.unlink(temp_path)


def test_file_entropy_calculation():
    """Test file entropy calculation"""
    with tempfile.NamedTemporaryFile(mode='wb', delete=False) as f:
        # Low entropy (repetitive content)
        f.write(b"A" * 1000)
        temp_path = f.name
    
    try:
        entropy = MalwareScanner.check_file_entropy(temp_path)
        assert 0 <= entropy <= 8
        assert entropy < 2  # Very low entropy for repetitive content
    finally:
        os.unlink(temp_path)
