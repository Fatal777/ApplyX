"""Malware scanning service for uploaded files"""

import logging
import hashlib
import os
from typing import Tuple, Optional
import magic

logger = logging.getLogger(__name__)


class MalwareScanner:
    """Service for scanning files for malware and suspicious content"""
    
    # Known malicious file signatures (simplified - in production use ClamAV or VirusTotal)
    SUSPICIOUS_SIGNATURES = [
        b'<script',
        b'javascript:',
        b'eval(',
        b'exec(',
        b'<?php',
        b'<%',
        b'\x4d\x5a\x90',  # PE executable header
        b'\x7f\x45\x4c\x46',  # ELF executable header
    ]
    
    # Maximum file size for scanning (10MB)
    MAX_SCAN_SIZE = 10 * 1024 * 1024
    
    @staticmethod
    def calculate_file_hash(file_path: str) -> str:
        """Calculate SHA256 hash of file"""
        sha256_hash = hashlib.sha256()
        
        try:
            with open(file_path, "rb") as f:
                for byte_block in iter(lambda: f.read(4096), b""):
                    sha256_hash.update(byte_block)
            return sha256_hash.hexdigest()
        except Exception as e:
            logger.error(f"Error calculating file hash: {str(e)}")
            return ""
    
    @classmethod
    def scan_file_content(cls, file_path: str) -> Tuple[bool, Optional[str]]:
        """
        Scan file content for malicious patterns
        Returns: (is_safe, reason)
        """
        try:
            file_size = os.path.getsize(file_path)
            
            # Skip scanning if file is too large
            if file_size > cls.MAX_SCAN_SIZE:
                logger.warning(f"File too large for content scanning: {file_size} bytes")
                return True, None
            
            with open(file_path, 'rb') as f:
                content = f.read()
            
            # Check for suspicious signatures
            for signature in cls.SUSPICIOUS_SIGNATURES:
                if signature in content:
                    reason = f"Suspicious content detected: {signature[:20]}"
                    logger.warning(f"Malware scan failed: {reason}")
                    return False, reason
            
            return True, None
            
        except Exception as e:
            logger.error(f"Error scanning file content: {str(e)}")
            return False, f"Scan error: {str(e)}"
    
    @staticmethod
    def validate_mime_type(file_path: str, expected_types: list) -> Tuple[bool, Optional[str]]:
        """
        Validate file MIME type matches expected types
        Returns: (is_valid, detected_type)
        """
        try:
            mime = magic.from_file(file_path, mime=True)
            
            if mime not in expected_types:
                logger.warning(f"MIME type mismatch. Expected: {expected_types}, Got: {mime}")
                return False, mime
            
            return True, mime
            
        except Exception as e:
            logger.error(f"Error validating MIME type: {str(e)}")
            return False, None
    
    @staticmethod
    def check_file_entropy(file_path: str) -> float:
        """
        Calculate file entropy to detect encrypted/packed files
        High entropy might indicate encrypted malware
        """
        try:
            import math
            from collections import Counter
            
            with open(file_path, 'rb') as f:
                data = f.read(1024 * 1024)  # Read first 1MB
            
            if not data:
                return 0.0
            
            # Calculate byte frequency
            counter = Counter(data)
            length = len(data)
            
            # Calculate entropy
            entropy = 0.0
            for count in counter.values():
                probability = count / length
                entropy -= probability * math.log2(probability)
            
            return entropy
            
        except Exception as e:
            logger.error(f"Error calculating entropy: {str(e)}")
            return 0.0
    
    @classmethod
    def comprehensive_scan(cls, file_path: str, file_type: str) -> Tuple[bool, str]:
        """
        Perform comprehensive security scan
        Returns: (is_safe, message)
        """
        logger.info(f"Starting comprehensive scan for: {file_path}")
        
        # Calculate file hash
        file_hash = cls.calculate_file_hash(file_path)
        logger.info(f"File hash: {file_hash}")
        
        # Validate MIME type
        expected_mimes = {
            'pdf': ['application/pdf'],
            'docx': ['application/vnd.openxmlformats-officedocument.wordprocessingml.document'],
            'doc': ['application/msword'],
            'txt': ['text/plain']
        }
        
        mime_valid, detected_mime = cls.validate_mime_type(
            file_path,
            expected_mimes.get(file_type, [])
        )
        
        if not mime_valid:
            return False, f"Invalid file type. Detected: {detected_mime}"
        
        # Scan content for malicious patterns
        content_safe, reason = cls.scan_file_content(file_path)
        if not content_safe:
            return False, reason or "Malicious content detected"
        
        # Check entropy (high entropy might indicate encryption/packing)
        entropy = cls.check_file_entropy(file_path)
        if entropy > 7.5:  # Very high entropy threshold
            logger.warning(f"High file entropy detected: {entropy}")
            # Don't reject, just log for monitoring
        
        logger.info(f"File passed all security checks. Entropy: {entropy:.2f}")
        return True, "File is safe"


# Singleton instance
malware_scanner = MalwareScanner()
