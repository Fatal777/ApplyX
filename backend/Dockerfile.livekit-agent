# Dockerfile for the LiveKit Interview Agent worker
# Runs the livekit-agents v1.3 process that connects to LiveKit Cloud/Server
# and handles real-time voice interaction via Deepgram + DO Gradient LLM.

FROM python:3.11-slim AS builder

WORKDIR /app

# System deps needed for building native extensions
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc g++ libffi-dev \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .

# Install only the packages the agent actually needs (skip heavy deps like spacy)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
    "livekit-agents[silero,turn-detector]~=1.3" \
    "livekit-plugins-noise-cancellation~=0.2" \
    "livekit-plugins-deepgram~=1.3" \
    "livekit-plugins-openai~=1.3" \
    python-dotenv \
    httpx

# Pre-download Silero VAD and turn-detector model files so the container
# doesn't have to fetch them at startup (faster cold-start).
RUN python -c "from livekit.plugins.silero import VAD; print('silero ok')" || true
RUN python -c "from livekit.plugins.turn_detector.multilingual import MultilingualModel; print('turn ok')" || true

# ── Production stage ──────────────────────────────────────────────────────

FROM python:3.11-slim

WORKDIR /app

# Runtime libs
RUN apt-get update && apt-get install -y --no-install-recommends \
    libffi8 \
    && rm -rf /var/lib/apt/lists/*

# Copy installed packages from builder
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy only the application code the agent needs
COPY app/__init__.py app/__init__.py
COPY app/agents/ app/agents/

# Non-root user
RUN useradd -m -u 1000 agentuser && chown -R agentuser:agentuser /app
USER agentuser

# The agent entrypoint — LiveKit agents CLI handles reconnection, scaling, etc.
ENTRYPOINT ["python", "-m", "app.agents.interview_agent"]
CMD ["start"]
